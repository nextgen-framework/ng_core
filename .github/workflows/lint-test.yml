name: Lint & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci || npm install

    - name: Run ESLint
      run: npm run lint
      continue-on-error: true

    - name: Check code formatting
      run: |
        # Check for trailing whitespace
        ! git grep -I --line-number --extended-regexp '\s+$' -- '*.js' '*.lua' '*.sql' || echo "Found trailing whitespace"

  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Validate fxmanifest.lua
      run: |
        test -f fxmanifest.lua || (echo "fxmanifest.lua not found" && exit 1)
        grep -q "fx_version" fxmanifest.lua || (echo "Missing fx_version" && exit 1)
        grep -q "game" fxmanifest.lua || (echo "Missing game declaration" && exit 1)

    - name: Validate JSON files
      run: |
        for file in $(find . -name "*.json" -not -path "./node_modules/*"); do
          echo "Validating $file"
          jq empty "$file" || exit 1
        done

    - name: Check SQL migrations
      run: |
        # Check that migration files are numbered correctly
        cd src/modules/database/migrations
        for file in *.sql; do
          if [[ ! $file =~ ^[0-9]{3}_ ]]; then
            echo "Migration file $file does not follow naming convention (NNN_description.sql)"
            exit 1
          fi
        done

  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci || npm install

    - name: Run npm audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD

  structure:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Verify directory structure
      run: |
        # Check essential directories exist
        test -d src/core || (echo "Missing src/core" && exit 1)
        test -d src/modules || (echo "Missing src/modules" && exit 1)

        # Check essential files exist
        test -f fxmanifest.lua || (echo "Missing fxmanifest.lua" && exit 1)
        test -f package.json || (echo "Missing package.json" && exit 1)
        test -f README.md || (echo "Missing README.md" && exit 1)

    - name: Check module structure
      run: |
        # Verify each module has required files
        for module in src/modules/*; do
          if [ -d "$module" ]; then
            module_name=$(basename "$module")
            echo "Checking module: $module_name"

            # Check for at least one of server.js or client.js
            if [ ! -f "$module/server.js" ] && [ ! -f "$module/client.js" ]; then
              echo "Module $module_name missing server.js or client.js"
              exit 1
            fi
          fi
        done
