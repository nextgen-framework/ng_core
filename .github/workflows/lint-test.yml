name: Lint & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Validate fxmanifest.lua
      run: |
        test -f fxmanifest.lua || (echo "fxmanifest.lua not found" && exit 1)
        grep -q "fx_version" fxmanifest.lua || (echo "Missing fx_version" && exit 1)
        grep -q "game" fxmanifest.lua || (echo "Missing game declaration" && exit 1)

    - name: Verify directory structure
      run: |
        # Check essential directories exist
        test -d src/core || (echo "Missing src/core" && exit 1)
        test -d src/modules || (echo "Missing src/modules" && exit 1)
        test -f package.json || (echo "Missing package.json" && exit 1)
        test -f README.md || (echo "Missing README.md" && exit 1)

    - name: Check module structure
      run: |
        # Verify each module has required files
        for module in src/modules/*; do
          if [ -d "$module" ]; then
            module_name=$(basename "$module")
            echo "Checking module: $module_name"

            # Check for at least one of server.js, client.js, or shared.js
            if [ ! -f "$module/server.js" ] && [ ! -f "$module/client.js" ] && [ ! -f "$module/shared.js" ]; then
              echo "Module $module_name missing server.js, client.js, or shared.js"
              exit 1
            fi
          fi
        done

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run ESLint
      run: npm run lint || echo "ESLint found issues"
      continue-on-error: true
